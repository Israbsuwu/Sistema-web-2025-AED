{% extends "vlastef_app/layout.html" %}
{% load static %}
{% load extra_images %}
{% block title %}Ver Producto - Moda Vlastef{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'vlastef_app/css/styles.css' %}">
  <style>
    :root{--card-bg:#fff;--accent:var(--brand);--muted:#8a8798}
    body{background:linear-gradient(180deg,#fbf8ff 0%, #f6f1fb 100%); padding-bottom: 120px;}
    .product-detail{max-width:1040px;margin:28px auto;padding:22px;background:var(--card-bg);border-radius:14px;box-shadow:0 14px 40px rgba(11,9,23,0.06);display:flex;gap:28px;align-items:flex-start}
    .pd-image{flex:0 0 460px;height: 460px; border-radius:12px;overflow:hidden;background:linear-gradient(180deg,rgba(196,49,196,0.06),rgba(231,18,203,0.03));display:flex;align-items:center;justify-content:center; position: relative;}
    .pd-image img{width:100%;height:100%;display:block;object-fit:contain; transition: opacity 0.3s ease;}
    .pd-image .carousel-img { display: none; width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }
    .pd-image .carousel-img.active { display: block; }
    
    /* Product Navigation Buttons */
    .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        color: var(--dark);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        font-size: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
        z-index: 10;
        opacity: 0;
        cursor: pointer;
        border: 1px solid rgba(0,0,0,0.05);
    }
    .pd-image:hover .nav-btn { opacity: 1; }
    .nav-btn:hover { background: #fff; transform: translateY(-50%) scale(1.1); color: var(--accent); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    .prev-btn { left: 15px; }
    .next-btn { right: 15px; }

    /* Zoom Modal */
    .zoom-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        padding-top: 50px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.9);
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
    }
    .zoom-modal.show {
        opacity: 1;
    }
    .zoom-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90vh;
        object-fit: contain;
        animation: zoomIn 0.3s;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    @keyframes zoomIn {
        from {transform:scale(0.8); opacity: 0;} 
        to {transform:scale(1); opacity: 1;}
    }

    .pd-info{flex:1;display:flex;flex-direction:column;gap:14px;padding-right:6px}
    .pd-title{font-size:22px;font-weight:700;color:var(--dark);margin:0}
    .pd-sku{font-size:13px;color:var(--muted)}
    .pd-price{font-size:26px;color:var(--accent);font-weight:800}
    .pd-old{font-size:14px;color:var(--muted);text-decoration:line-through;margin-left:10px}
    .pd-meta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:14px}
    .pd-desc{color:#333;line-height:1.5}
    .pd-actions{display:flex;gap:12px;margin-top:6px}
    .btn{padding:10px 16px;border-radius:10px;border:0;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--dark)}
    .back-row{display:flex;align-items:center;gap:12px;margin-bottom:6px}
    .back-row a{color:var(--muted);text-decoration:none;font-size:14px}
    @media (max-width:960px){
      .product-detail{flex-direction:column;padding:16px}
      .pd-image{width:100%;flex:0 0 auto}
      .pd-info{padding:0}
    }
    @media (max-width:480px){
      .pd-title{font-size:18px}
      .pd-price{font-size:20px}
      .product-detail{padding:12px}
    }
    
    /* Comments Section */
    .comments-section { max-width: 1040px; width: 95%; margin: 28px auto 100px; padding: 22px; background: var(--card-bg); border-radius: 14px; box-shadow: 0 14px 40px rgba(11,9,23,0.06); }
    .comments-section h3 { margin-top: 0; color: var(--dark); }
    .comment-form { background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
    .comment-form h4 { margin-top: 0; margin-bottom: 15px; }
    .comment-form textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: vertical; margin-bottom: 15px; font-family: inherit; }
    .comment-item { border-bottom: 1px solid #eee; padding: 15px 0; }
    .comment-item:last-child { border-bottom: none; }
    .comment-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .comment-date { color: var(--muted); font-size: 0.9em; }
    .comment-rating { color: #FFD700; margin-bottom: 8px; }
    .comment-text { line-height: 1.5; color: #444; }
    
    /* Star Rating Input */
    .rating-input { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .stars-input { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
    .stars-input input { display: none; }
    .stars-input label { font-size: 24px; color: #ddd; cursor: pointer; transition: color 0.2s; }
    .stars-input label:hover, .stars-input label:hover ~ label, .stars-input input:checked ~ label { color: #FFD700; }
    .star.filled { color: #FFD700; }
    .star { color: #ddd; font-size: 18px; }

    /* Toast Styles */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: white; color: #333; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; min-width: 300px; max-width: 400px; animation: slideInRight 0.3s ease forwards; border-left: 4px solid #333; opacity: 0; transform: translateX(100%); }
    .toast.success { border-left-color: #2ecc71; }
    .toast.error { border-left-color: #e74c3c; }
    .toast.info { border-left-color: #3498db; }
    .toast.warning { border-left-color: #f39c12; }
    .toast-icon { font-size: 20px; }
    .toast.success .toast-icon { color: #2ecc71; }
    .toast.error .toast-icon { color: #e74c3c; }
    .toast.info .toast-icon { color: #3498db; }
    .toast.warning .toast-icon { color: #f39c12; }
    .toast-content { flex: 1; }
    .toast-title { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
    .toast-message { font-size: 13px; color: #666; }
    .toast-close { background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 0; margin-left: 8px; }
    .toast-close:hover { color: #333; }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    
    /* Comment Highlight */
    .comment-item { position: relative; }
    .comment-item::after {
        content: "";
        position: absolute;
        top: -8px; left: -8px; right: -8px; bottom: -8px;
        border: 2px solid red;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.25);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.6s ease;
        z-index: 10;
    }
    .comment-item.comment-highlight::after {
        opacity: 1;
    }
  </style>
{% endblock %}
{% block extra_js %}
  <script src="{% static 'vlastef_app/js/scripts.js' %}"></script>
{% endblock %}
{% block body %}
  <header class="topbar" style="background:transparent;padding:18px 22px;border-bottom:1px solid rgba(0,0,0,0.03)">
    <div style="display:flex;align-items:center;gap:12px">
      <a href="{% url 'catalogo_home' %}" class="logo" style="color:var(--accent);font-weight:700;font-size:16px;text-decoration:none">← Volver al listado</a>
    </div>
    <div style="flex:1"></div>
  </header>

  <main class="container">
    <div id="productDetail" class="product-detail" aria-live="polite">
        {% with extras=producto.id|extra_images %}
        <div class="pd-image" id="imageCarousel">
            <!-- Main Image -->
            {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="carousel-img active" data-index="0">
            {% else %}
                <img src="{% static 'vlastef_app/images/no-image.png' %}" alt="Sin imagen" class="carousel-img active" data-index="0">
            {% endif %}

            <!-- Extra Images -->
            {% for img in extras %}
                <img src="{{ img.url }}" alt="{{ producto.nombre }} - extra {{ forloop.counter }}" class="carousel-img" data-index="{{ forloop.counter }}">
            {% endfor %}
            
            {% if extras %}
                <button class="nav-btn prev-btn" onclick="changeImage(-1)">❮</button>
                <button class="nav-btn next-btn" onclick="changeImage(1)">❯</button>
            {% endif %}
        </div>
        {% endwith %}
        <div class="pd-info">
          <div class="back-row">
              <a href="{% url 'catalogo_home' %}">← Volver al listado</a>
              {% if user.is_staff or user.is_superuser %}
                  {% if request.GET.cid %}
                      <a href="{% url 'admin_comentarios' %}" style="margin-left: 15px; color: var(--brand); font-weight: 600; text-decoration: none;">← Volver al Panel</a>
                  {% endif %}
              {% endif %}
          </div>
          <div class="pd-title">{{ producto.nombre }}</div>
          <div class="pd-meta">
            <div class="pd-sku">ID: {{ producto.id }}</div>
            <div class="pd-category">Categoria: <strong>{{ producto.categoria.nombre|default:'--' }}</strong></div>
          </div>
          <div>
            <span class="pd-price">C$ {{ producto.precio_venta }}</span>
          </div>
          <div class="pd-desc">{{ producto.descripcion|default:'Sin descripción' }}</div>

          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            {% if producto.tallas %}
            <div class="select-inline">
              <label for="sizeSelect">Talla:</label>
              <select id="sizeSelect" data-options="{{ producto.tallas }}">
                <!-- JS populated -->
              </select>
            </div>
            {% endif %}
            
            {% if producto.colores %}
            <div class="select-inline">
              <label for="colorSelect">Color:</label>
              <select id="colorSelect" data-options="{{ producto.colores }}">
                 <!-- JS populated -->
              </select>
            </div>
            {% endif %}

            <div class="select-inline">
              <label for="qtyInput">Cantidad:</label>
              <input id="qtyInput" class="qty-input" type="number" min="1" value="1">
            </div>
          </div>

          <div class="pd-actions">
            <button type="button" class="btn primary" id="addToCartBtn" onclick="addToCart()">Añadir al carrito</button>
            <a href="{% url 'catalogo_home' %}" class="btn ghost">Volver</a>
          </div>
        </div>
    </div>

    <div class="comments-section">
      <h3>Comentarios y Calificaciones</h3>
      
      {% if user.is_authenticated %}
        <div class="comment-form">
          <h4>{% if user_comment %}Edita tu comentario{% else %}Deja tu opinión{% endif %}</h4>
          <form method="POST">
            {% csrf_token %}
            <div class="rating-input">
               <label>Calificación:</label>
               <div class="stars-input">
                 <input type="radio" name="calificacion" value="5" id="star5" {% if user_comment.calificacion == 5 or not user_comment %}checked{% endif %}><label for="star5">★</label>
                 <input type="radio" name="calificacion" value="4" id="star4" {% if user_comment.calificacion == 4 %}checked{% endif %}><label for="star4">★</label>
                 <input type="radio" name="calificacion" value="3" id="star3" {% if user_comment.calificacion == 3 %}checked{% endif %}><label for="star3">★</label>
                 <input type="radio" name="calificacion" value="2" id="star2" {% if user_comment.calificacion == 2 %}checked{% endif %}><label for="star2">★</label>
                 <input type="radio" name="calificacion" value="1" id="star1" {% if user_comment.calificacion == 1 %}checked{% endif %}><label for="star1">★</label>
               </div>
            </div>
            <textarea name="texto" rows="4" placeholder="Escribe tu comentario aquí..." required>{{ user_comment.texto|default:'' }}</textarea>
            <button type="submit" class="btn primary">{% if user_comment %}Actualizar{% else %}Enviar{% endif %}</button>
          </form>
        </div>
      {% else %}
        <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center;">
            <p style="margin:0;">Debes <a href="{% url 'index' %}" style="color: var(--accent); font-weight: bold;">iniciar sesión</a> para dejar un comentario.</p>
        </div>
      {% endif %}

      <div class="comments-list">
        {% for c in comentarios %}
          <div class="comment-item" id="comment-{{ c.id }}">
            <div class="comment-header">
              <strong>{{ c.cliente.nombres }} {{ c.cliente.apellidos }}</strong>
              <span class="comment-date">{{ c.fecha|date:"d M Y" }}</span>
            </div>
            <div class="comment-rating">
              {% if c.calificacion >= 1 %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
              {% if c.calificacion >= 2 %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
              {% if c.calificacion >= 3 %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
              {% if c.calificacion >= 4 %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
              {% if c.calificacion >= 5 %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
            </div>
            <div class="comment-text">{{ c.texto }}</div>
          </div>
        {% empty %}
          <p style="color: var(--muted); text-align: center; padding: 20px;">No hay comentarios aún. ¡Sé el primero en opinar!</p>
        {% endfor %}
      </div>
    </div>
  </main>

  <script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Image Carousel Logic
    let currentImageIndex = 0;
    
    function changeImage(direction) {
        const images = document.querySelectorAll('.carousel-img');
        if (images.length <= 1) return;
        
        // Hide current
        images[currentImageIndex].classList.remove('active');
        
        // Calculate next
        currentImageIndex += direction;
        if (currentImageIndex >= images.length) currentImageIndex = 0;
        if (currentImageIndex < 0) currentImageIndex = images.length - 1;
        
        // Show next
        images[currentImageIndex].classList.add('active');
    }

    // Populate selects
    document.addEventListener('DOMContentLoaded', function() {
        ['sizeSelect', 'colorSelect'].forEach(id => {
            const el = document.getElementById(id);
            if(el && el.dataset.options) {
                const opts = el.dataset.options.split(',');
                opts.forEach(o => {
                    if(o.trim()){
                        const op = document.createElement('option');
                        op.value = o.trim();
                        op.textContent = o.trim();
                        el.appendChild(op);
                    }
                });
            }
        });

        // Zoom Modal Logic
        const modal = document.getElementById('imageZoomModal');
        const modalImg = document.getElementById('zoomedImage');
        
        // Add click event to all carousel images
        document.querySelectorAll('.carousel-img').forEach(img => {
            img.addEventListener('click', function() {
                modal.style.display = "flex"; // Use flex to center
                modal.style.alignItems = "center";
                modal.style.justifyContent = "center";
                // Small delay to allow display:flex to apply before opacity transition
                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
                modalImg.src = this.src;
            });
        });

        // Close functions
        function closeModal() {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = "none";
            }, 300);
        }

        modal.onclick = function(event) {
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape" && modal.style.display !== "none") {
                closeModal();
            }
        });
    });

    // Highlight comment from URL
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const cid = urlParams.get('cid');
        if (cid) {
            const commentEl = document.getElementById('comment-' + cid);
            if (commentEl) {
                // Scroll to element
                commentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add highlight class
                commentEl.classList.add('comment-highlight');
                // Remove after 2 seconds
                setTimeout(() => {
                    commentEl.classList.remove('comment-highlight');
                }, 2000);
            }
        }
    });

    function addToCart() {
        const qty = document.getElementById('qtyInput').value;
        const prodId = "{{ producto.id }}";
        const sizeSelect = document.getElementById('sizeSelect');
        const colorSelect = document.getElementById('colorSelect');
        
        const talla = sizeSelect ? sizeSelect.value : null;
        const color = colorSelect ? colorSelect.value : null;
        
        fetch("{% url 'add_to_cart' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ 
                id: prodId, 
                qty: qty,
                talla: talla,
                color: color
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                showMessage('Producto agregado al carrito', 'success');
                setTimeout(() => {
                    window.location.href = "{% url 'catalogo_home' %}";
                }, 1500);
            } else {
                showMessage(data.error || 'Error al agregar', 'error');
            }
        });
    }

    // Toast Notification Implementation
    function showMessage(text, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'fa-info-circle';
        let title = 'Información';
        
        if (type === 'success') { icon = 'fa-check-circle'; title = 'Éxito'; }
        else if (type === 'error') { icon = 'fa-exclamation-circle'; title = 'Error'; }
        else if (type === 'warning') { icon = 'fa-exclamation-triangle'; title = 'Advertencia'; }
        
        toast.innerHTML = `
            <div class="toast-icon"><i class="fas ${icon}"></i></div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${text}</div>
            </div>
            <button class="toast-close">&times;</button>
        `;
        
        container.appendChild(toast);
        
        const removeToast = () => {
            toast.style.animation = 'fadeOutRight 0.3s ease forwards';
            toast.addEventListener('animationend', () => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            });
        };
        
        setTimeout(removeToast, 3000);
        toast.querySelector('.toast-close').addEventListener('click', removeToast);
    }

    /* {% if messages %} */
      document.addEventListener('DOMContentLoaded', function() {
        /* {% for message in messages %} */
          var msgText = "{{ message|escapejs }}";
          var msgTags = "{{ message.tags }}";
          var type = 'info';
          
          if (msgTags.indexOf('success') !== -1) type = 'success';
          else if (msgTags.indexOf('warning') !== -1 || msgTags.indexOf('error') !== -1) type = 'error';
          
          showMessage(msgText, type);
        /* {% endfor %} */
      });
    /* {% endif %} */
  </script>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Zoom Modal -->
  <div id="imageZoomModal" class="zoom-modal">
      <img class="zoom-content" id="zoomedImage">
  </div>
{% endblock %}
